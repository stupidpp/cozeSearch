const cloud = require('wx-server-sdk');
const axios = require('axios');

// åˆå§‹åŒ–äº‘å¼€å‘
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

// æ£€æŸ¥æ˜¯å¦ä¸ºæ— å…³æé—®çš„å›ç­”
function isIrrelevantResponse(text) {
  if (!text || typeof text !== 'string') {
    return false;
  }
  
  // æ— å…³æé—®çš„å…³é”®è¯å’Œæ¨¡å¼
  const irrelevantPatterns = [
    /æŠ±æ­‰.*æ— æ³•.*æä¾›.*å›ç­”/i,
    /æˆ‘ä»¬æ— æ³•ä¸ºæ‚¨æä¾›.*çš„å›ç­”/i,
    /ä¸åœ¨.*æœåŠ¡èŒƒå›´/i,
    /ä¸“æ³¨äº.*ç§‘ç ”.*åˆä½œ/i,
    /è¯·é—®.*ç§‘ç ”.*éœ€æ±‚/i,
    /æˆ‘æ˜¯.*ç§‘ç ”.*åŠ©æ‰‹/i,
    /åªèƒ½.*ç§‘ç ”.*ç›¸å…³/i,
    /é¢„çº¦.*è¿›æ ¡/i,
    /ç”Ÿæ´».*æœåŠ¡/i,
    /è¡Œæ”¿.*äº‹åŠ¡/i,
    /æ ¡å›­.*å¯¼èˆª/i,
    /è¯¾ç¨‹.*å®‰æ’/i,
    /è€ƒè¯•.*æˆç»©/i,
    /å®¿èˆ.*é£Ÿå ‚/i
  ];
  
  return irrelevantPatterns.some(pattern => pattern.test(text));
}

// æ£€æŸ¥æ˜¯å¦ä¸ºè¯¦ç»†è¯¢é—®æŸä¸ªç‰¹å®šæ•™æˆ
function isSpecificProfessorInquiry(userInput) {
  if (!userInput || typeof userInput !== 'string') {
    return false;
  }
  
  const specificPatterns = [
    /.*æ•™æˆ.*æ€ä¹ˆæ ·/i,
    /.*æ•™æˆ.*è¯¦ç»†.*ä¿¡æ¯/i,
    /.*æ•™æˆ.*ç ”ç©¶.*æ–¹å‘/i,
    /.*æ•™æˆ.*è”ç³».*æ–¹å¼/i,
    /.*æ•™æˆ.*å‘è¡¨.*è®ºæ–‡/i,
    /.*æ•™æˆ.*å…·ä½“.*åšä»€ä¹ˆ/i,
    /è¯¦ç»†.*ä»‹ç».*æ•™æˆ/i,
    /èƒ½å¦.*è¯¦ç»†.*è¯´æ˜/i,
    /å…·ä½“.*äº†è§£.*æ•™æˆ/i,
    /æ›´å¤š.*å…³äº.*æ•™æˆ/i
  ];
  
  return specificPatterns.some(pattern => pattern.test(userInput));
}

// ä»æ–‡æœ¬ä¸­è§£ææ•™æˆä¿¡æ¯å¹¶ç”Ÿæˆå¡ç‰‡æ•°æ®
function parseProfesorInfoFromText(text) {
  try {
    if (!text || typeof text !== 'string') {
      return null;
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºæ— å…³æé—®çš„å›ç­”
    if (isIrrelevantResponse(text)) {
      console.log('âš ï¸ æ£€æµ‹åˆ°æ— å…³æé—®å›ç­”ï¼Œè·³è¿‡æ•™æˆä¿¡æ¯è§£æ');
      return null;
    }

    // å¿…é¡»åŒ…å«æ•™æˆæ¨èçš„æ˜ç¡®ç‰¹å¾æ‰è¿›è¡Œè§£æ
    const hasValidProfessorIndicators = [
      /æ•™æˆ.*æ¨è/i,
      /æ¨è.*æ•™æˆ/i,
      /ä»¥ä¸‹.*æ•™æˆ/i,
      /ä¸ºæ‚¨æ¨è/i,
      /\d+\.\s*\*\*[^*]+\*\*.*?(å­¦é™¢|ç ”ç©¶æ‰€|ç³»)/i  // ç¼–å·+æ•™æˆå§“å+å­¦é™¢æ ¼å¼
    ].some(pattern => pattern.test(text));

    if (!hasValidProfessorIndicators) {
      console.log('âš ï¸ æ–‡æœ¬ä¸­æœªæ£€æµ‹åˆ°æ•™æˆæ¨èç‰¹å¾ï¼Œè·³è¿‡è§£æ');
      return null;
    }

    const professors = [];
    
    // åŒ¹é…æ•™æˆä¿¡æ¯ï¼šç¼–å·+å§“åæ ¼å¼
    let professorMatches = text.match(/(\d+\.\s*\*\*([^*]+)\*\*[^]*?)(?=\d+\.\s*\*\*|$)/g);
    
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¼–å·æ ¼å¼ï¼Œå°è¯•åŒ¹é…å•ä¸ªæ•™æˆ
    if (!professorMatches || professorMatches.length === 0) {
      const singleProfRegex = /\*\*([^*]+)\*\*[^]*?(å­¦é™¢|ç ”ç©¶æ‰€|ç³»)/i;
      const singleProfMatch = text.match(singleProfRegex);
      if (singleProfMatch) {
        professorMatches = [singleProfMatch[0]];
      }
    }
    
    if (professorMatches && professorMatches.length > 0) {
      professorMatches.forEach((match, index) => {
        try {
          // æå–æ•™æˆå§“å
          const nameMatch = match.match(/\*\*([^*]+)\*\*/);
          const name = nameMatch ? nameMatch[1].trim() : `æ•™æˆ${index + 1}`;
          
          // æå–å­¦é™¢ä¿¡æ¯
          let school = '';
          const schoolPatterns = [
            /æµ™æ±Ÿå¤§å­¦([^ï¼Œã€‚ï¼š:]*?)(å­¦é™¢|ç ”ç©¶æ‰€|ç³»)/i,
            /([^ï¼Œã€‚ï¼š:*]*?)(å­¦é™¢|ç ”ç©¶æ‰€|ç³»)/i
          ];
          
          for (const pattern of schoolPatterns) {
            const schoolMatch = match.match(pattern);
            if (schoolMatch) {
              school = (schoolMatch[1] + schoolMatch[2]).trim();
              // æ¸…ç†å­¦é™¢åç§°
              school = school.replace(/^(æµ™æ±Ÿå¤§å­¦|æµ™å¤§)/, '').trim();
              school = school.replace(/\*\*[^*]*\*\*[ï¼š:]*/, '').trim();
              if (school && school.length > 2 && !school.includes('*')) {
                break;
              }
            }
          }
          if (!school) school = 'æœªçŸ¥å­¦é™¢';
          
          // æå–é‚®ç®±
          let email = '';
          const emailMatch = match.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
          if (emailMatch) {
            email = emailMatch[1].trim();
          }

          // æå–åŠå…¬åœ°ç‚¹
          let office = '';
          const officeMatch = match.match(/(?:åŠå…¬åœ°ç‚¹|åŠå…¬å®¤|åœ°å€)[ï¼š:\s]*([^\nã€‚ï¼›,ï¼Œ]+)/i);
          if (officeMatch && officeMatch[1]) {
            office = officeMatch[1].trim().replace(/[ã€‚ï¼›,ï¼Œ].*$/, '');
          }

          // æå–è”ç³»ç”µè¯
          let phone = '';
          const phoneMatch = match.match(/(?:ç”µè¯|æ‰‹æœº|tel)[ï¼š:\s]*([\d\s\-\+\(\)]{8,20})/i);
          if (phoneMatch && phoneMatch[1]) {
            phone = phoneMatch[1].trim().replace(/[^\d\-\+\(\)\s]/g, '');
          }
          
          // æå–ä¸»é¡µé“¾æ¥
          const homepages = [];
          const urlMatches = match.match(/(https?:\/\/[^\sï¼Œã€‚ï¼‰\n,]+)/g);
          if (urlMatches) {
            urlMatches.forEach(url => {
              if (!homepages.includes(url)) {
                homepages.push(url);
              }
            });
          }
          
          // æå–æ ‡ç­¾/ç ”ç©¶æ–¹å‘ - åªä¿ç•™æ ¸å¿ƒå…³é”®è¯
          const tags = [];
          const coreKeywords = [
            'è®¡ç®—æœºè§†è§‰', 'äººå·¥æ™ºèƒ½', 'æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ', 
            'è‡ªç„¶è¯­è¨€å¤„ç†', 'å¤§æ¨¡å‹', 'å¤šæ¨¡æ€', 'æ•°æ®æŒ–æ˜',
            'æ™ºèƒ½æ§åˆ¶', 'è½¯ä»¶å·¥ç¨‹', 'ç½‘ç»œå®‰å…¨', 'æ•°æ®åº“', 'äº‘è®¡ç®—',
            'ç‰©è”ç½‘', 'åŒºå—é“¾', 'åŒ»å­¦äººå·¥æ™ºèƒ½', 'ç”Ÿç‰©åŒ»å­¦å·¥ç¨‹',
            'ææ–™ç§‘å­¦', 'åŒ–å­¦å·¥ç¨‹', 'æœºæ¢°å·¥ç¨‹', 'ç”µæ°”å·¥ç¨‹',
            'æ–°èƒ½æº', 'å…‰ç”µæŠ€æœ¯', 'ç”Ÿç‰©æŠ€æœ¯'
          ];
          
          coreKeywords.forEach(keyword => {
            if (match.toLowerCase().includes(keyword.toLowerCase())) {
              if (!tags.includes(keyword)) {
                tags.push(keyword);
              }
            }
          });
          
          // æå–ç ”ç©¶æˆæœ/äº®ç‚¹
          let researchContent = match;
          // æ¸…ç†è”ç³»ä¿¡æ¯
          researchContent = researchContent.replace(/\*\*[^*]+\*\*/g, '');
          researchContent = researchContent.replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, '');
          researchContent = researchContent.replace(/https?:\/\/[^\sï¼Œã€‚ï¼‰\n,]+/g, '');
          researchContent = researchContent.replace(/(é‚®ç®±|ç”µè¯|ä¸»é¡µ|ç½‘ç«™|åŠå…¬åœ°ç‚¹|åœ°å€|è”ç³»æ–¹å¼)[ï¼š:]?[^ã€‚\n]*[ã€‚\n]?/g, '');
          
          const achievements = researchContent
            .split(/[ã€‚ï¼›;\n]/)
            .map(s => s.replace(/^\d+\.\s*/, '').replace(/^[-â€¢]\s*/, '').trim())
            .filter(s => s.length > 15 && !/(é‚®ç®±|ç”µè¯|ä¸»é¡µ|ç½‘ç«™|åŠå…¬åœ°ç‚¹|åœ°å€|è”ç³»æ–¹å¼|http|@)/.test(s))
            .slice(0, 3);
          
          const finalHighlights = achievements.length > 0 ? achievements : [
            'åœ¨ç›¸å…³ç ”ç©¶é¢†åŸŸå…·æœ‰ä¸°å¯Œç»éªŒ'
          ];
          
          // è®¡ç®—åŒ¹é…åº¦
          let score = 60; // åŸºç¡€åˆ†
          if (email) score += 10;
          if (homepages.length > 0) score += 10;
          if (finalTags.length > 0) score += 10;
          if (achievements.length > 2) score += 5;
          if (office) score += 2;
          if (phone) score += 3;
          
          const professorData = {
            name: name,
            school: school,
            areas: tags.slice(0, 3), // æœ€å¤š3ä¸ªç ”ç©¶æ–¹å‘æ ‡ç­¾
            highlights: finalHighlights,
            score: Math.min(score, 100),
            displayScore: Math.min(score, 100),
            profId: `prof_${Date.now()}_${index}`,
            documentId: `doc_${Date.now()}_${index}`
          };
          
          // åªæœ‰åœ¨æœ‰å€¼çš„æƒ…å†µä¸‹æ‰æ·»åŠ 
          if (email) {
            professorData.email = email;
          }
          if (office) {
            professorData.office = office;
          }
          if (phone) {
            professorData.phone = phone;
          }
          if (homepages.length > 0) {
            professorData.homepages = homepages;
          }
          
          professors.push(professorData);
          
        } catch (e) {
          console.log(`è§£æç¬¬${index + 1}ä½æ•™æˆä¿¡æ¯å¤±è´¥:`, e);
        }
      });
    }
    
    if (professors.length > 0) {
      console.log(`æˆåŠŸè§£æ ${professors.length} ä½æ•™æˆä¿¡æ¯`);
      return {
        type: "professor_list",
        professors: professors
      };
    }
    
  } catch (e) {
    console.log('è§£ææ•™æˆä¿¡æ¯å¤±è´¥:', e);
  }
  
  return null;
}

// ä»æ•°æ®åº“ç›´æ¥æŸ¥è¯¢æ•™æˆä¿¡æ¯
// ä¸“é—¨æ ¹æ®æ•™æˆå§“åä»æ•°æ®åº“æŸ¥è¯¢è”ç³»ä¿¡æ¯
async function queryProfessorsByNames(professorNames) {
  try {
    console.log('ğŸ” æ ¹æ®æ•™æˆå§“åä»æ•°æ®åº“æŸ¥è¯¢è”ç³»ä¿¡æ¯:', professorNames);
    
    const allProfessors = [];
    
    // ä¸ºæ¯ä¸ªæ•™æˆåç§°å•ç‹¬æŸ¥è¯¢
    for (const name of professorNames) {
      try {
        const result = await cloud.callFunction({
          name: 'search_professors',
          data: {
            q: name,
            page: 1,
            pageSize: 3,
            sortBy: 'time'
          }
        });
        
        if (result && result.result && result.result.code === 0 && 
            result.result.data && result.result.data.list && result.result.data.list.length > 0) {
          
          // å¯»æ‰¾æœ€åŒ¹é…çš„æ•™æˆè®°å½•
          let bestMatch = null;
          let bestScore = 0;
          
          for (const doc of result.result.data.list) {
            if (!doc.name) continue;
            
            const similarity = calculateNameSimilarity(name, doc.name);
            if (similarity > bestScore) {
              bestScore = similarity;
              bestMatch = doc;
            }
          }
          
          if (bestMatch && bestScore > 0.6) {
            const professor = {
              name: bestMatch.name,
              originalName: name, // ä¿ç•™åŸå§‹AIè§£æçš„åç§°
              school: bestMatch.school || 'æœªçŸ¥å­¦é™¢',
              email: bestMatch.email || '',
              homepages: bestMatch.homepage ? [bestMatch.homepage.trim()] : [],
              office: bestMatch.office || '',
              phone: bestMatch.phone || '',
              matchScore: bestScore
            };
            
            allProfessors.push(professor);
            console.log(`âœ… æ‰¾åˆ°åŒ¹é…: ${name} -> ${bestMatch.name} (ç›¸ä¼¼åº¦: ${bestScore.toFixed(2)})`);
          } else {
            console.log(`âš ï¸ æœªæ‰¾åˆ°åŒ¹é…: ${name}`);
          }
          
        } else {
          console.log(`âš ï¸ æŸ¥è¯¢ ${name} æ— ç»“æœ`);
        }
        
      } catch (err) {
        console.error(`âŒ æŸ¥è¯¢æ•™æˆ ${name} å¤±è´¥:`, err);
      }
    }
    
    console.log(`ğŸ“Š æˆåŠŸæŸ¥è¯¢åˆ° ${allProfessors.length} ä½æ•™æˆçš„æ•°æ®åº“ä¿¡æ¯`);
    return allProfessors;
    
  } catch (error) {
    console.error('âŒ æ ¹æ®å§“åæŸ¥è¯¢æ•™æˆå¤±è´¥:', error);
    return [];
  }
}

// å¤‡ç”¨çš„é€šç”¨æŸ¥è¯¢ï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼‰
async function queryProfessorsFromDatabase(userInput, responseText) {
  try {
    console.log('ğŸ” ä»æ•°æ®åº“æŸ¥è¯¢æ•™æˆä¿¡æ¯...');
    
    // ç®€åŒ–å…³é”®è¯æå–
    const combinedText = (userInput || '') + ' ' + (responseText || '');
    let queryKeyword = '';
    
    // åŒ¹é…æ ¸å¿ƒå…³é”®è¯
    const coreKeywords = ['è®¡ç®—æœºè§†è§‰', 'äººå·¥æ™ºèƒ½', 'æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ', 'å¤§æ•°æ®', 'ç½‘ç»œå®‰å…¨', 'ç”Ÿç‰©åŒ»å­¦'];
    for (const keyword of coreKeywords) {
      if (combinedText.includes(keyword)) {
        queryKeyword = keyword;
        break;
      }
    }
    
    // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°å…³é”®è¯ï¼Œä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ç¬¬ä¸€ä¸ªæœ‰æ„ä¹‰çš„è¯
    if (!queryKeyword) {
      const cleanInput = userInput.replace(/[æˆ‘æƒ³æ‰¾åˆä½œæ•™æˆçš„æ–¹å‘æ¨èä¸€äº›ç»™]/g, '').trim();
      queryKeyword = cleanInput || 'æ•™æˆ';
    }
    
    // è°ƒç”¨search_professorsäº‘å‡½æ•°
    const result = await cloud.callFunction({
      name: 'search_professors',
      data: {
        q: queryKeyword,
        page: 1,
        pageSize: 5,
        sortBy: 'time'
      }
    });
    
    if (result && result.result && result.result.code === 0 && 
        result.result.data && result.result.data.list && result.result.data.list.length > 0) {
      
      const professors = result.result.data.list.map((doc, index) => ({
        name: doc.name || 'æœªçŸ¥',
        school: doc.school || 'æœªçŸ¥å­¦é™¢',
        // è”ç³»ä¿¡æ¯ï¼ˆæ•°æ®åº“çš„æ ¸å¿ƒä»·å€¼ï¼‰
        email: doc.email || '',
        homepages: doc.homepage ? [doc.homepage.trim()] : [],
        office: doc.office || '',
        phone: doc.phone || '',
        // åŸºç¡€ä¿¡æ¯ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
        areas: Array.isArray(doc.areas) ? doc.areas.slice(0, 3) : [],
        highlights: Array.isArray(doc.highlights) ? doc.highlights.slice(0, 3) : [],
        score: 85 + Math.random() * 10,
        displayScore: 85 + Math.random() * 10,
        profId: doc.profId || `prof_db_${Date.now()}_${index}`,
        documentId: `doc_db_${Date.now()}_${index}`
      }));
      
      return {
        type: "professor_list",
        professors: professors
      };
    }
    
    return null;
    
  } catch (error) {
    console.error('âŒ æ•°æ®åº“æŸ¥è¯¢æ•™æˆä¿¡æ¯å¤±è´¥:', error);
    return null;
  }
}

// é‡æ–°è®¾è®¡çš„ä¸¥æ ¼åŒ¹é…æ··åˆé€»è¾‘ï¼ˆå½»åº•è§£å†³ä¿¡æ¯é”™ä¹±é—®é¢˜ï¼‰
async function createHybridProfessorCards(userInput, responseText) {
  try {
    console.log('ğŸ”„ ä½¿ç”¨ä¸¥æ ¼æ··åˆé€»è¾‘ç”Ÿæˆæ•™æˆå¡ç‰‡ï¼ˆé˜²æ­¢ä¿¡æ¯é”™ä¹±ï¼‰...');
    
    // ç¬¬ä¸€æ­¥ï¼šä»AIå›å¤ä¸­æå–æ•™æˆå­¦æœ¯ä¿¡æ¯
    const aiProfessors = parseAcademicInfoFromText(responseText);
    if (!aiProfessors || aiProfessors.length === 0) {
      console.log('âš ï¸ AIå›å¤ä¸­æœªæ‰¾åˆ°æ•™æˆå­¦æœ¯ä¿¡æ¯');
      return null;
    }
    
    console.log(`âœ… ä»AIå›å¤æå–åˆ° ${aiProfessors.length} ä½æ•™æˆçš„å­¦æœ¯ä¿¡æ¯`);
    aiProfessors.forEach((prof, i) => {
      console.log(`  AIæ•™æˆ${i+1}: ${prof.name} (${prof.school})`);
    });
    
    // ç¬¬äºŒæ­¥ï¼šæ ¹æ®AIè§£æçš„æ•™æˆå§“åç²¾ç¡®æŸ¥è¯¢æ•°æ®åº“
    const professorNames = aiProfessors.map(prof => prof.name);
    const dbProfessors = await queryProfessorsByNames(professorNames);
    
    console.log(`ğŸ“Š ä»æ•°æ®åº“ç²¾ç¡®æŸ¥è¯¢åˆ° ${dbProfessors.length} ä½æ•™æˆçš„è”ç³»ä¿¡æ¯`);
    dbProfessors.forEach((prof, i) => {
      console.log(`  DBæ•™æˆ${i+1}: ${prof.name} -> åŸå: ${prof.originalName}, é‚®ç®±: ${prof.email}, ä¸»é¡µ: ${prof.homepages?.[0] || 'æ— '}`);
    });

    // ç¬¬ä¸‰æ­¥ï¼šä¸¥æ ¼ä¸€å¯¹ä¸€åŒ¹é…ï¼ˆå½»åº•é¿å…ä¿¡æ¯é”™ä¹±ï¼‰
    const hybridProfessors = [];
    const usedDbProfessors = new Set();
    
    for (let i = 0; i < aiProfessors.length; i++) {
      const aiProf = aiProfessors[i];
      console.log(`\nğŸ”„ å¤„ç†AIæ•™æˆ${i+1}: ${aiProf.name}`);
      
      // å¯»æ‰¾å®Œå…¨åŒ¹é…çš„æ•°æ®åº“è®°å½•
      let matchedDbProf = null;
      
      // æ–¹æ³•1ï¼šåŸå§‹æŸ¥è¯¢åç§°å®Œå…¨åŒ¹é…
      for (const dbProf of dbProfessors) {
        if (usedDbProfessors.has(dbProf.name)) continue;
        
        if (dbProf.originalName === aiProf.name) {
          matchedDbProf = dbProf;
          console.log(`ğŸ¯ åŸå§‹åç§°å®Œå…¨åŒ¹é…: ${aiProf.name} -> ${dbProf.name}`);
          break;
        }
      }
      
      // æ–¹æ³•2ï¼šæ•°æ®åº“å§“åå®Œå…¨åŒ¹é…
      if (!matchedDbProf) {
        for (const dbProf of dbProfessors) {
          if (usedDbProfessors.has(dbProf.name)) continue;
          
          if (dbProf.name === aiProf.name) {
            matchedDbProf = dbProf;
            console.log(`ğŸ¯ æ•°æ®åº“åç§°å®Œå…¨åŒ¹é…: ${aiProf.name} -> ${dbProf.name}`);
            break;
          }
        }
      }
      
      // åˆ›å»ºæ··åˆæ•™æˆæ•°æ®
      const hybridProf = {
        name: aiProf.name,
        school: aiProf.school || 'æœªçŸ¥å­¦é™¢',
        areas: aiProf.areas || [],
        highlights: aiProf.highlights || [],
        score: aiProf.score || 85,
        displayScore: aiProf.displayScore || 85,
        profId: aiProf.profId || `prof_hybrid_${Date.now()}_${i}`,
        documentId: aiProf.documentId || `doc_hybrid_${Date.now()}_${i}`
      };
      
      // å¦‚æœæ‰¾åˆ°åŒ¹é…çš„æ•°æ®åº“è®°å½•ï¼Œæ·»åŠ è”ç³»ä¿¡æ¯
      if (matchedDbProf) {
        usedDbProfessors.add(matchedDbProf.name);
        
        // æ·»åŠ å‡†ç¡®çš„è”ç³»ä¿¡æ¯
        if (matchedDbProf.email && matchedDbProf.email.includes('@')) {
          hybridProf.email = matchedDbProf.email;
        }
        if (matchedDbProf.homepages && matchedDbProf.homepages.length > 0) {
          hybridProf.homepages = [...new Set(matchedDbProf.homepages)]; // å»é‡
        }
        if (matchedDbProf.office) {
          hybridProf.office = matchedDbProf.office;
        }
        if (matchedDbProf.phone) {
          hybridProf.phone = matchedDbProf.phone;
        }
        if (matchedDbProf.school) {
          hybridProf.school = matchedDbProf.school;
        }
        
        console.log(`âœ… ${aiProf.name} åŒ¹é…æˆåŠŸï¼Œè”ç³»ä¿¡æ¯: é‚®ç®±=${hybridProf.email || 'æ— '}, ä¸»é¡µ=${hybridProf.homepages?.[0] || 'æ— '}`);
      } else {
        console.log(`âš ï¸ ${aiProf.name} æœªæ‰¾åˆ°åŒ¹é…çš„æ•°æ®åº“è®°å½•ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ`);
        
        // å¤‡ç”¨æ–¹æ¡ˆï¼šç”Ÿæˆæ ‡å‡†ä¸»é¡µ
        const standardHomepage = generateZjuHomepage(aiProf.name);
        if (standardHomepage) {
          hybridProf.homepages = [standardHomepage];
          console.log(`ğŸ« ä¸º ${aiProf.name} ç”Ÿæˆæ ‡å‡†ä¸»é¡µ: ${standardHomepage}`);
        }
      }
      
      hybridProfessors.push(hybridProf);
    }
    
    // æœ€ç»ˆéªŒè¯
    console.log('\nğŸ“‹ æœ€ç»ˆæ•™æˆä¿¡æ¯éªŒè¯:');
    hybridProfessors.forEach((prof, i) => {
      console.log(`æ•™æˆ${i+1}: ${prof.name}`);
      console.log(`  é‚®ç®±: ${prof.email || 'æ— '}`);
      console.log(`  ä¸»é¡µ: ${prof.homepages?.join(', ') || 'æ— '}`);
      console.log(`  å­¦é™¢: ${prof.school}`);
    });
    
    return {
      type: "professor_list", 
      professors: hybridProfessors
    };
    
  } catch (error) {
    console.error('âŒ ä¸¥æ ¼æ··åˆé€»è¾‘å¤„ç†å¤±è´¥:', error);
    return null;
  }
}



        

          console.log(`ï¿½ ç›¸ä¼¼åº¦åŒ¹é…: ${aiProf.name} -> ${bestDbMatch.name} (${bestMatchScore.toFixed(2)})`);
        }
      }


        
        // å¤‡ç”¨æ–¹æ¡ˆ2: ç”Ÿæˆæµ™å¤§æ ‡å‡†ä¸»é¡µæ ¼å¼ (æ ¹æ®å§“åæ¨æµ‹)
        if (!hybridProf.homepages || hybridProf.homepages.length === 0) {



// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦åœ¨è¯¢é—®è”ç³»ä¿¡æ¯
function isAskingForContactInfo(userInput) {
  if (!userInput || typeof userInput !== 'string') {
    return false;
  }
  
  const contactQuestionPatterns = [
    /.*é‚®ç®±.*(æ˜¯ä»€ä¹ˆ|å¤šå°‘|æ€ä¹ˆè”ç³»)/i,
    /.*ä¸»é¡µ.*(æ˜¯ä»€ä¹ˆ|åœ¨å“ª|é“¾æ¥)/i,
    /.*ç”µè¯.*(æ˜¯ä»€ä¹ˆ|å¤šå°‘|æ€ä¹ˆè”ç³»)/i,
    /.*åŠå…¬åœ°ç‚¹.*(åœ¨å“ª|åœ°å€)/i,
    /.*è”ç³»æ–¹å¼.*(æ˜¯ä»€ä¹ˆ|æ€ä¹ˆè”ç³»)/i,
    /.*æ€ä¹ˆè”ç³».*æ•™æˆ/i,
    /.*æ•™æˆ.*è”ç³»æ–¹å¼/i,
    /.*æ•™æˆ.*é‚®ç®±/i,
    /.*æ•™æˆ.*ä¸»é¡µ/i,
    /.*æ•™æˆ.*ç”µè¯/i,
    /é‚®ç®±/i,
    /ä¸»é¡µ/i,
    /ç½‘å€/i,
    /è”ç³»ç”µè¯/i,
    /åŠå…¬åœ°ç‚¹/i,
    /åŠå…¬å®¤/i
  ];
  
  return contactQuestionPatterns.some(pattern => pattern.test(userInput));
}

// ä»AIå›å¤ä¸­æå–è”ç³»ä¿¡æ¯ï¼ˆç”¨äºç”¨æˆ·è¯¢é—®è”ç³»æ–¹å¼æ—¶ï¼‰
function extractContactInfoFromText(text) {
  if (!text || typeof text !== 'string') {
    return {};
  }
  
  const contactInfo = {
    emails: [],
    homepages: [],
    phones: [],
    offices: []
  };
  
  try {
    // æå–é‚®ç®±
    const emailPattern = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
    const emails = text.match(emailPattern);
    if (emails) {
      contactInfo.emails = [...new Set(emails)]; // å»é‡
    }
    
    // å¼ºåŒ–URLï¼ˆä¸»é¡µï¼‰æå– - æ”¯æŒå¤šç§æ ¼å¼
    const urlPatterns = [
      // æ ‡å‡†HTTP/HTTPSé“¾æ¥
      /https?:\/\/[^\sï¼Œã€‚ï¼‰\n,\]]+/g,
      // ä¸ªäººä¸»é¡µå…³é”®è¯åçš„é“¾æ¥
      /(?:ä¸ªäººä¸»é¡µ|ä¸»é¡µ|ç½‘ç«™|homepage|website)[ï¼š:\s]*([^\sï¼Œã€‚ï¼‰\n,\]]+)/gi,
      // æµ™å¤§ä¸ªäººä¸»é¡µæ ¼å¼
      /person\.zju\.edu\.cn\/[^\sï¼Œã€‚ï¼‰\n,\]]+/g,
      // å…¶ä»–å¸¸è§å­¦æœ¯ä¸»é¡µæ ¼å¼
      /[a-zA-Z0-9.-]+\.edu(?:\.cn)?\/[~\/\w.-]+/g
    ];
    
    const allUrls = new Set();
    
    for (const pattern of urlPatterns) {
      const matches = text.matchAll(pattern);
      for (const match of matches) {
        let url = match[1] || match[0]; // ä½¿ç”¨æ•è·ç»„æˆ–æ•´ä¸ªåŒ¹é…
        
        // æ¸…ç†URL
        url = url.trim().replace(/[ï¼Œã€‚ï¼‰\]]+$/, ''); // ç§»é™¤æœ«å°¾çš„ä¸­æ–‡æ ‡ç‚¹
        
        // éªŒè¯URLæ ¼å¼
        if (url && (url.startsWith('http') || url.includes('.edu') || url.includes('person.zju'))) {
          // ç¡®ä¿ä»¥httpå¼€å¤´
          if (!url.startsWith('http')) {
            if (url.startsWith('//')) {
              url = 'https:' + url;
            } else {
              url = 'https://' + url;
            }
          }
          
          allUrls.add(url);
        }
      }
    }
    
    contactInfo.homepages = [...allUrls];
    
    // æå–ç”µè¯
    const phonePattern = /(?:è”ç³»ç”µè¯|ç”µè¯|æ‰‹æœº|tel)[ï¼š:\s]*([\d\s\-\+\(\)]{8,20})/gi;
    const phoneMatches = text.matchAll(phonePattern);
    for (const match of phoneMatches) {
      if (match[1]) {
        contactInfo.phones.push(match[1].trim());
      }
    }
    
    // æå–åŠå…¬åœ°ç‚¹
    const officePattern = /(?:åŠå…¬åœ°ç‚¹|åŠå…¬å®¤|åœ°å€)[ï¼š:\s]*([^\nã€‚ï¼›,ï¼Œ]+)/gi;
    const officeMatches = text.matchAll(officePattern);
    for (const match of officeMatches) {
      if (match[1]) {
        contactInfo.offices.push(match[1].trim());
      }
    }
    
    console.log('ğŸ” ä»AIå›å¤æå–çš„è”ç³»ä¿¡æ¯:', contactInfo);
    
  } catch (error) {
    console.error('âŒ æå–è”ç³»ä¿¡æ¯å¤±è´¥:', error);
  }
  
  return contactInfo;
}

// ä¸“é—¨æå–æ•™æˆä¸ªäººä¸»é¡µçš„å¢å¼ºå‡½æ•°
function extractProfessorHomepages(text, professorName) {
  const homepages = [];
  
  if (!text || typeof text !== 'string') {
    return homepages;
  }
  
  try {
    console.log(`ğŸ” ä¸ºæ•™æˆ ${professorName} æå–ä¸ªäººä¸»é¡µ...`);
    
    // æå–è¯¥æ•™æˆç›¸å…³æ®µè½
    const professorSection = extractProfessorSection(text, professorName);
    const searchText = professorSection || text;
    
    console.log(`ğŸ“„ æœç´¢æ–‡æœ¬é•¿åº¦: ${searchText.length}`);
    
    // å¤šç§ä¸»é¡µæå–æ¨¡å¼
    const homepagePatterns = [
      // 1. æ ‡å‡†HTTP/HTTPSé“¾æ¥
      /https?:\/\/[^\sï¼Œã€‚ï¼‰\n,\]ã€ã€‘]+/g,
      
      // 2. ä¸ªäººä¸»é¡µå…³é”®è¯æ¨¡å¼
      /(?:ä¸ªäººä¸»é¡µ|ä¸»é¡µ|ç½‘ç«™|homepage|website)[ï¼š:\s]*([^\sï¼Œã€‚ï¼‰\n,\]ã€ã€‘]+)/gi,
      
      // 3. æµ™å¤§ç‰¹å®šæ ¼å¼
      /person\.zju\.edu\.cn\/[^\sï¼Œã€‚ï¼‰\n,\]ã€ã€‘]+/g,
      
      // 4. å­¦æœ¯ç½‘ç«™å¸¸è§æ ¼å¼
      /[a-zA-Z0-9.-]+\.(?:edu|edu\.cn|ac\.cn|org|com)\/[~\/\w.-]+/g,
      
      // 5. ResearchGate, Google Scholarç­‰å­¦æœ¯å¹³å°
      /(?:researchgate\.net|scholar\.google|orcid\.org|ieee\.org)\/[^\sï¼Œã€‚ï¼‰\n,\]ã€ã€‘]+/g
    ];
    
    for (const pattern of homepagePatterns) {
      const matches = searchText.matchAll(pattern);
      for (const match of matches) {
        let url = match[1] || match[0];
        
        // æ¸…ç†URL
        url = url.trim()
          .replace(/[ï¼Œã€‚ï¼‰\]ã€ã€‘]+$/, '') // ç§»é™¤æœ«å°¾æ ‡ç‚¹
          .replace(/\s+$/, ''); // ç§»é™¤æœ«å°¾ç©ºæ ¼
        
        // éªŒè¯å’Œæ ‡å‡†åŒ–URL
        if (url && isValidHomepageUrl(url)) {
          // ç¡®ä¿ä»¥httpå¼€å¤´
          if (!url.startsWith('http')) {
            if (url.startsWith('//')) {
              url = 'https:' + url;
            } else {
              url = 'https://' + url;
            }
          }
          
          if (!homepages.includes(url)) {
            homepages.push(url);
            console.log(`âœ… æ‰¾åˆ°ä¸»é¡µ: ${url}`);
          }
        }
      }
    }
    
    console.log(`ğŸ“ ä¸º ${professorName} æå–åˆ° ${homepages.length} ä¸ªä¸»é¡µé“¾æ¥`);
    
  } catch (error) {
    console.error(`âŒ æå– ${professorName} ä¸»é¡µå¤±è´¥:`, error);
  }
  
  return homepages;
}

// æå–ç‰¹å®šæ•™æˆçš„ç›¸å…³æ®µè½
function extractProfessorSection(text, professorName) {
  try {
    // å¯»æ‰¾æ•™æˆå§“åå‘¨å›´çš„å†…å®¹
    const nameIndex = text.indexOf(professorName);
    if (nameIndex === -1) return null;
    
    // æå–å‰åå„500å­—ç¬¦çš„å†…å®¹
    const start = Math.max(0, nameIndex - 200);
    const end = Math.min(text.length, nameIndex + 800);
    
    return text.substring(start, end);
  } catch (error) {
    console.error('æå–æ•™æˆæ®µè½å¤±è´¥:', error);
    return null;
  }
}

// éªŒè¯URLæ˜¯å¦ä¸ºæœ‰æ•ˆçš„ä¸»é¡µé“¾æ¥
function isValidHomepageUrl(url) {
  if (!url || typeof url !== 'string') return false;
  
  // åŸºæœ¬é•¿åº¦æ£€æŸ¥
  if (url.length < 10 || url.length > 200) return false;
  
  // åŒ…å«æœ‰æ•ˆåŸŸåç‰¹å¾
  const validDomains = [
    '.edu', '.edu.cn', '.ac.cn', '.org', '.com', '.net',
    'zju.edu.cn', 'person.zju', 'scholar.google', 'researchgate',
    'orcid.org', 'ieee.org', 'acm.org'
  ];
  
  const hasValidDomain = validDomains.some(domain => url.toLowerCase().includes(domain));
  
  // æ’é™¤æ˜æ˜¾çš„éä¸»é¡µé“¾æ¥
  const invalidPatterns = [
    /\.(jpg|jpeg|png|gif|pdf|doc|docx|ppt|pptx)$/i,
    /\.(zip|rar|tar|gz)$/i,
    /^\d+$/,
    /^[,ï¼Œã€‚ï¼›;]+/
  ];
  
  const isInvalid = invalidPatterns.some(pattern => pattern.test(url));
  
  return hasValidDomain && !isInvalid;
}

// ç”Ÿæˆæµ™å¤§æ ‡å‡†ä¸»é¡µæ ¼å¼ (æ ¹æ®æ•™æˆå§“åå’Œå­¦é™¢æ¨æµ‹)
function generateZjuHomepage(professorName) {
  if (!professorName || professorName.length < 2) {
    return null;
  }
  
  try {
    console.log(`ğŸ« ä¸º ${professorName} ç”Ÿæˆæµ™å¤§æ ‡å‡†ä¸»é¡µ...`);
    
    // æµ™å¤§ä¸ªäººä¸»é¡µçš„å¸¸è§æ ¼å¼
    // https://person.zju.edu.cn/å§“åæ‹¼éŸ³ æˆ– https://person.zju.edu.cn/å·¥å·
    
    // ç”ŸæˆåŸºäºå§“åçš„å¯èƒ½ä¸»é¡µ
    const possibleHomepages = [];
    
    // æ–¹æ¡ˆ1: åŸºäºå§“åæ‹¼éŸ³çš„ä¸»é¡µæ ¼å¼
    const pinyinName = convertToPinyin(professorName);
    if (pinyinName) {
      possibleHomepages.push(`https://person.zju.edu.cn/${pinyinName}`);
      possibleHomepages.push(`https://person.zju.edu.cn/${pinyinName.toLowerCase()}`);
    }
    
    // æ–¹æ¡ˆ2: åŸºäºå§“æ°çš„ä¸»é¡µæ ¼å¼  
    if (professorName.length >= 2) {
      const surname = professorName.substring(0, 1);
      const givenName = professorName.substring(1);
      const pinyinSurname = convertToPinyin(surname);
      const pinyinGivenName = convertToPinyin(givenName);
      
      if (pinyinSurname && pinyinGivenName) {
        possibleHomepages.push(`https://person.zju.edu.cn/${pinyinSurname}${pinyinGivenName}`);
        possibleHomepages.push(`https://person.zju.edu.cn/${pinyinSurname.toLowerCase()}${pinyinGivenName.toLowerCase()}`);
      }
    }
    
    // è¿”å›ç¬¬ä¸€ä¸ªå¯èƒ½çš„ä¸»é¡µï¼ˆæœ€å¸¸è§çš„æ ¼å¼ï¼‰
    if (possibleHomepages.length > 0) {
      const generatedHomepage = possibleHomepages[0];
      console.log(`ğŸ¯ ç”Ÿæˆæ ‡å‡†ä¸»é¡µ: ${generatedHomepage}`);
      return generatedHomepage;
    }
    
  } catch (error) {
    console.error(`âŒ ç”Ÿæˆ ${professorName} æ ‡å‡†ä¸»é¡µå¤±è´¥:`, error);
  }
  
  return null;
}

// ç®€å•çš„ä¸­æ–‡è½¬æ‹¼éŸ³å‡½æ•° (åŸºæœ¬ç‰ˆæœ¬)
function convertToPinyin(chineseName) {
  // å¸¸è§ä¸­æ–‡å§“åæ‹¼éŸ³æ˜ å°„è¡¨ (ç®€åŒ–ç‰ˆ)
  const pinyinMap = {
    'ç‹': 'wang', 'æ': 'li', 'å¼ ': 'zhang', 'åˆ˜': 'liu', 'é™ˆ': 'chen',
    'æ¨': 'yang', 'èµµ': 'zhao', 'é»„': 'huang', 'å‘¨': 'zhou', 'å´': 'wu',
    'å¾': 'xu', 'å­™': 'sun', 'èƒ¡': 'hu', 'æœ±': 'zhu', 'é«˜': 'gao',
    'æ—': 'lin', 'ä½•': 'he', 'éƒ­': 'guo', 'é©¬': 'ma', 'ç½—': 'luo',
    'æ¢': 'liang', 'å®‹': 'song', 'éƒ‘': 'zheng', 'è°¢': 'xie', 'éŸ©': 'han',
    'å”': 'tang', 'å†¯': 'feng', 'äº': 'yu', 'è‘£': 'dong', 'è§': 'xiao',
    'ç¨‹': 'cheng', 'æ›¹': 'cao', 'è¢': 'yuan', 'é‚“': 'deng', 'è®¸': 'xu',
    'å‚…': 'fu', 'æ²ˆ': 'shen', 'æ›¾': 'zeng', 'å½­': 'peng', 'å•': 'lv',
    'è‹': 'su', 'å¢': 'lu', 'è’‹': 'jiang', 'è”¡': 'cai', 'è´¾': 'jia',
    'ä¸': 'ding', 'é­': 'wei', 'è–›': 'xue', 'å¶': 'ye', 'é˜': 'yan',
    'ä½™': 'yu', 'æ½˜': 'pan', 'æœ': 'du', 'æˆ´': 'dai', 'å¤': 'xia',
    'é’Ÿ': 'zhong', 'æ±ª': 'wang', 'ç”°': 'tian', 'ä»»': 'ren', 'å§œ': 'jiang',
    'èŒƒ': 'fan', 'æ–¹': 'fang', 'çŸ³': 'shi', 'å§š': 'yao', 'è°­': 'tan',
    'ç››': 'sheng', 'é‚¹': 'zou', 'ç†Š': 'xiong', 'é‡‘': 'jin', 'é™†': 'lu',
    'éƒ': 'hao', 'å­”': 'kong', 'ç™½': 'bai', 'å´”': 'cui', 'åº·': 'kang',
    'æ¯›': 'mao', 'é‚±': 'qiu', 'ç§¦': 'qin', 'æ±Ÿ': 'jiang', 'å²': 'shi',
    'é¡¾': 'gu', 'ä¾¯': 'hou', 'é‚µ': 'shao', 'å­Ÿ': 'meng', 'é¾™': 'long',
    'ä¸‡': 'wan', 'æ®µ': 'duan', 'æ¼•': 'cao', 'é’±': 'qian', 'æ±¤': 'tang',
    'å°¹': 'yin', 'é»': 'li', 'æ˜“': 'yi', 'å¸¸': 'chang', 'æ­¦': 'wu',
    'ä¹”': 'qiao', 'è´º': 'he', 'èµ–': 'lai', 'é¾š': 'gong', 'æ–‡': 'wen',
    
    // å¸¸è§åå­—å­—ç¬¦
    'ä¼Ÿ': 'wei', 'èŠ³': 'fang', 'å¨œ': 'na', 'æ•': 'min', 'é™': 'jing',
    'ä¸½': 'li', 'å¼º': 'qiang', 'ç£Š': 'lei', 'å†›': 'jun', 'æ´‹': 'yang',
    'å‹‡': 'yong', 'è‰³': 'yan', 'æ°': 'jie', 'å¨Ÿ': 'juan', 'æ¶›': 'tao',
    'æ˜': 'ming', 'è¶…': 'chao', 'ç§€': 'xiu', 'éœ': 'xia', 'å¹³': 'ping',
    'åˆš': 'gang', 'æ¡‚': 'gui', 'è‹±': 'ying', 'å': 'hua', 'ç‰': 'yu',
    'è': 'ping', 'çº¢': 'hong', 'ç‡•': 'yan', 'ä¸¹': 'dan', 'é˜³': 'yang',
    'å¸†': 'fan', 'é›ª': 'xue', 'æ¢…': 'mei', 'è¾‰': 'hui', 'æµ©': 'hao',
    'å‡¯': 'kai', 'æ¬£': 'xin', 'æ™¨': 'chen', 'å®‡': 'yu', 'èˆª': 'hang',
    'é¹': 'peng', 'ç³': 'lin', 'å©·': 'ting', 'å³°': 'feng', 'æ–Œ': 'bin',
    'æ™¶': 'jing', 'å…°': 'lan', 'é›¨': 'yu', 'é‘«': 'xin', 'è‰': 'li',
    'åš': 'bo', 'è¿œ': 'yuan', 'ç¿”': 'xiang', 'é¾™': 'long', 'ç‘': 'rui',
    'å¿—': 'zhi', 'ä¸œ': 'dong', 'å—': 'nan', 'è¥¿': 'xi', 'åŒ—': 'bei',
    'é›·': 'lei', 'è•¾': 'lei', 'æ€': 'si', 'æ…§': 'hui', 'æ–°': 'xin'
  };
  
  if (!chineseName || typeof chineseName !== 'string') {
    return null;
  }
  
  let pinyin = '';
  for (let i = 0; i < chineseName.length; i++) {
    const char = chineseName[i];
    if (pinyinMap[char]) {
      pinyin += pinyinMap[char];
    } else {
      // å¦‚æœæ‰¾ä¸åˆ°æ˜ å°„ï¼Œä½¿ç”¨å­—ç¬¦çš„Unicodeç¼–ç ä½œä¸ºå¤‡ç”¨
      return null; // æ— æ³•è½¬æ¢åˆ™è¿”å›null
    }
  }
  
  return pinyin || null;
}

// æ¸…ç†å›ç­”æ–‡æœ¬ï¼Œæ™ºèƒ½å¤„ç†è”ç³»ä¿¡æ¯
function cleanResponseText(text, cardData, userInput = '') {
  // å¦‚æœæœ‰æ•™æˆå¡ç‰‡æ•°æ®ä½†ç”¨æˆ·è¯¢é—®è”ç³»ä¿¡æ¯ï¼Œæä¾›è”ç³»ä¿¡æ¯æ€»ç»“
  if (cardData && cardData.type === 'professor_list' && cardData.professors && cardData.professors.length > 0) {
    if (isAskingForContactInfo(userInput)) {
      console.log('ğŸ” ç”¨æˆ·è¯¢é—®è”ç³»ä¿¡æ¯ï¼Œç”Ÿæˆè”ç³»æ–¹å¼æ€»ç»“');
      
      let contactSummary = 'ä»¥ä¸‹æ˜¯æ•™æˆçš„è”ç³»æ–¹å¼ï¼š\n\n';
      cardData.professors.forEach((prof, index) => {
        contactSummary += `**${prof.name}**\n`;
        if (prof.email) contactSummary += `é‚®ç®±ï¼š${prof.email}\n`;
        if (prof.homepages && prof.homepages.length > 0) {
          contactSummary += `ä¸ªäººä¸»é¡µï¼š${prof.homepages.join(', ')}\n`;
        }
        if (prof.office) contactSummary += `åŠå…¬åœ°ç‚¹ï¼š${prof.office}\n`;
        if (prof.phone) contactSummary += `è”ç³»ç”µè¯ï¼š${prof.phone}\n`;
        
        // å¦‚æœæ²¡æœ‰ä»»ä½•è”ç³»ä¿¡æ¯ï¼Œä»åŸæ–‡æå–
        if (!prof.email && !prof.homepages && !prof.office && !prof.phone) {
          const extractedContact = extractContactInfoFromText(text);
          if (extractedContact.emails.length > 0) {
            contactSummary += `é‚®ç®±ï¼š${extractedContact.emails[index] || extractedContact.emails[0]}\n`;
          }
          if (extractedContact.homepages.length > 0) {
            contactSummary += `ä¸ªäººä¸»é¡µï¼š${extractedContact.homepages[index] || extractedContact.homepages[0]}\n`;
          }
          if (extractedContact.offices.length > 0) {
            contactSummary += `åŠå…¬åœ°ç‚¹ï¼š${extractedContact.offices[index] || extractedContact.offices[0]}\n`;
          }
          if (extractedContact.phones.length > 0) {
            contactSummary += `è”ç³»ç”µè¯ï¼š${extractedContact.phones[index] || extractedContact.phones[0]}\n`;
          }
        }
        
        if (index < cardData.professors.length - 1) {
          contactSummary += '\n';
        }
      });
      
      return contactSummary;
    }
    
    // å¸¸è§„æƒ…å†µï¼šéšè—æ–‡å­—å›å¤
    return '';
  }

  if (!text || typeof text !== 'string') {
    return '';
  }
  
  let cleanedText = text;
  
  // æ¸…ç†å¼•ç”¨æ ‡è®°
  cleanedText = cleanedText.replace(/\[\d+\]\s*prof_info/gi, '');
  cleanedText = cleanedText.replace(/\[\d+\]/g, '');
  cleanedText = cleanedText.replace(/ã€\d+ã€‘/g, '');
  
  // å¦‚æœç”¨æˆ·æ˜ç¡®è¯¢é—®è”ç³»ä¿¡æ¯ï¼Œåˆ™ä¿ç•™ç›¸å…³å†…å®¹
  if (isAskingForContactInfo(userInput)) {
    console.log('ğŸ” ç”¨æˆ·è¯¢é—®è”ç³»ä¿¡æ¯ï¼Œä¿ç•™è”ç³»æ–¹å¼å†…å®¹');
    // åªæ¸…ç†å¼•ç”¨æ ‡è®°ï¼Œä¿ç•™è”ç³»ä¿¡æ¯
    return cleanedText.replace(/\n\s*\n/g, '\n').replace(/\s+/g, ' ').trim();
  }
  
  // å¸¸è§„æƒ…å†µï¼šç§»é™¤è”ç³»ä¿¡æ¯ç›¸å…³çš„å¥å­å’Œæ®µè½
  cleanedText = cleanedText.replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, ''); // ç§»é™¤é‚®ç®±
  cleanedText = cleanedText.replace(/https?:\/\/[^\sï¼Œã€‚ï¼‰\n,]+/g, ''); // ç§»é™¤URL
  cleanedText = cleanedText.replace(/(?:è”ç³»ç”µè¯|ç”µè¯|æ‰‹æœº|tel)[ï¼š:\s]*[\d\s\-\+\(\)]{8,20}/gi, ''); // ç§»é™¤ç”µè¯
  cleanedText = cleanedText.replace(/(?:åŠå…¬åœ°ç‚¹|åŠå…¬å®¤|åœ°å€)[ï¼š:\s]*[^\nã€‚ï¼›,ï¼Œ]+/gi, ''); // ç§»é™¤åœ°å€
  cleanedText = cleanedText.replace(/(é‚®ç®±|ç”µè¯|ä¸»é¡µ|ç½‘ç«™|åŠå…¬åœ°ç‚¹|åœ°å€|è”ç³»æ–¹å¼|è”ç³»ç”µè¯)[ï¼š:]?[^ã€‚\n]*[ã€‚\n]?/gi, ''); // ç§»é™¤è”ç³»ä¿¡æ¯å¥å­
  
  // ç§»é™¤ç©ºè¡Œå’Œå¤šä½™ç©ºæ ¼
  cleanedText = cleanedText.replace(/\n\s*\n/g, '\n').replace(/\s+/g, ' ').trim();
  
  return cleanedText;
}

exports.main = async (event) => {
  console.log('æ”¶åˆ°äº‹ä»¶:', JSON.stringify(event, null, 2));
  
  // å…¼å®¹ Node.js 10.15 çš„å‚æ•°è§£æ„æ–¹å¼
  const eventData = event || {};
  const input = eventData.input || '';
  const bot_id = eventData.bot_id || '7537877620181041204'; // ä½ çš„æ™ºèƒ½ä½“ID
  const conversation_id = eventData.conversation_id || ''; // å¯¹è¯ID
  const user_id = eventData.user_id || 'miniprogram_user'; // ç”¨æˆ·ID

  console.log('è§£æåçš„å‚æ•°:', { input, bot_id, conversation_id, user_id });

  if (!input) {
    return { code: 400, message: 'input required' };
  }

  // ä»ç¯å¢ƒå˜é‡è·å–tokenï¼ˆç”Ÿäº§ç¯å¢ƒå®‰å…¨æ–¹å¼ï¼‰
  const COZE_TOKEN = process.env.COZE_TOKEN;
  // æ£€æŸ¥tokené…ç½®
  
  if (!COZE_TOKEN) {
    console.error('COZE_TOKEN ç¯å¢ƒå˜é‡æœªé…ç½®');
    return { code: 500, message: 'COZE_TOKEN environment variable not configured' };
  }

  // ä½¿ç”¨æ–°çš„Chat API v3
  const url = 'https://api.coze.cn/v3/chat';
  const headers = {
    Authorization: `Bearer ${COZE_TOKEN}`,
    'Content-Type': 'application/json',
    Accept: 'application/json', // éæµå¼
  };

  // æ„å»ºèŠå¤©è¯·æ±‚ä½“ï¼ˆæŒ‰ç…§å®˜æ–¹æ–‡æ¡£æ ¼å¼ï¼‰
  const body = {
    bot_id: bot_id,
    user_id: user_id,
    stream: false, // éæµå¼
    auto_save_history: true, // è‡ªåŠ¨ä¿å­˜å¯¹è¯å†å²
  };

  // å¦‚æœæœ‰å¯¹è¯IDï¼Œä½¿ç”¨conversation_idè¿›è¡Œå¤šè½®å¯¹è¯
  if (conversation_id) {
    body.conversation_id = conversation_id;
    // å¤šè½®å¯¹è¯æ¨¡å¼ï¼šåªå‘é€å½“å‰ç”¨æˆ·æ¶ˆæ¯
    body.additional_messages = [
      {
        content: input,
        content_type: "text",
        role: "user",
        type: "question"
      }
    ];
  } else {
    // é¦–è½®å¯¹è¯æ¨¡å¼ï¼šä½¿ç”¨messageså­—æ®µ
    body.messages = [
      {
        content: input,
        content_type: "text", 
        role: "user",
        type: "question"
      }
    ];
  }

  try {
    
    const resp = await axios.post(url, body, { 
      headers: headers, 
      timeout: 30000,
      validateStatus: function (status) {
        return status < 500; // æ¥å—æ‰€æœ‰å°äº500çš„çŠ¶æ€ç 
      }
    });
    
    // APIè°ƒç”¨æˆåŠŸ
    
    const result = resp.data;
    
    if (resp.status !== 200) {
      throw new Error(`APIè°ƒç”¨å¤±è´¥: ${resp.status} - ${result?.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
    }

    // è·å–chat_idå’Œconversation_id
    const chat_id = result.data?.id;
    const conversation_id_new = result.data?.conversation_id || conversation_id;
    
    if (!chat_id) {
      throw new Error('æœªè·å–åˆ°chat_id');
    }

    // å¦‚æœçŠ¶æ€æ˜¯in_progressï¼Œéœ€è¦è½®è¯¢è·å–æœ€ç»ˆç»“æœ
    let chatStatus = result.data?.status;
    let finalResult = result;
    let retryCount = 0;
    const maxRetries = 20; // å¢åŠ åˆ°20æ¬¡
    
    while (chatStatus === 'in_progress' && retryCount < maxRetries) {
      console.log(`=== è½®è¯¢è·å–ç»“æœ (ç¬¬${retryCount + 1}æ¬¡) ===`);
      
      // åŠ¨æ€è°ƒæ•´ç­‰å¾…æ—¶é—´ï¼šå‰å‡ æ¬¡çŸ­ä¸€äº›ï¼Œåé¢é•¿ä¸€äº›
      const retryInterval = retryCount < 5 ? 2000 : (retryCount < 10 ? 3000 : 4000);
      console.log(`ç­‰å¾… ${retryInterval}ms åæŸ¥è¯¢...`);
      
      // ç­‰å¾…ä¸€æ®µæ—¶é—´å†æŸ¥è¯¢
      await new Promise(resolve => setTimeout(resolve, retryInterval));
      
      // æŸ¥è¯¢èŠå¤©ç»“æœ
      const queryResp = await axios.get(`https://api.coze.cn/v3/chat/retrieve?chat_id=${chat_id}&conversation_id=${conversation_id_new}`, {
        headers: headers,
        timeout: 15000,
        validateStatus: function (status) {
          return status < 500;
        }
      });
      
      console.log(`è½®è¯¢å“åº” (${retryCount + 1}):`, JSON.stringify(queryResp.data, null, 2));
      
      if (queryResp.status === 200 && queryResp.data?.data) {
        finalResult = queryResp.data;
        chatStatus = queryResp.data.data.status;
        
        if (chatStatus === 'completed') {
          console.log('âœ… æ™ºèƒ½ä½“å¤„ç†å®Œæˆ');
          break;
        } else if (chatStatus === 'failed') {
          console.error('âŒ æ™ºèƒ½ä½“å¤„ç†å¤±è´¥ï¼Œè¯¦ç»†ä¿¡æ¯:', JSON.stringify(queryResp.data, null, 2));
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯ä½™é¢ä¸è¶³çš„é”™è¯¯
          const errorCode = queryResp.data?.data?.last_error?.code;
          const errorMsg = queryResp.data?.data?.last_error?.msg;
          
          if (errorCode === 4028) {
            console.log('ğŸ’° æ£€æµ‹åˆ°ä½™é¢ä¸è¶³é”™è¯¯ï¼Œå°†è¿”å›ç‰¹æ®Šæç¤º');
          }
          
          // ä¸è¦ç«‹å³æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­å°è¯•è·å–æ¶ˆæ¯
          break;
        }
      }
      
      retryCount++;
    }

    if (chatStatus === 'in_progress') {
      console.warn('âš ï¸ è½®è¯¢è¶…æ—¶ï¼Œå°è¯•è·å–å½“å‰æ¶ˆæ¯');
      // å³ä½¿è½®è¯¢è¶…æ—¶ï¼Œä¹Ÿå°è¯•è·å–å¯èƒ½å·²ç»ç”Ÿæˆçš„æ¶ˆæ¯
    } else if (chatStatus === 'failed') {
      console.warn('âš ï¸ æ™ºèƒ½ä½“å¤„ç†å¤±è´¥ï¼Œä½†ä»å°è¯•è·å–å¯èƒ½çš„æ¶ˆæ¯');
    }

    // è·å–èŠå¤©æ¶ˆæ¯ - æ— è®ºæ˜¯å¦å®Œæˆéƒ½å°è¯•è·å–
    let messagesResp;
    try {
      messagesResp = await axios.get(`https://api.coze.cn/v3/chat/message/list?chat_id=${chat_id}&conversation_id=${conversation_id_new}`, {
        headers: headers,
        timeout: 15000,
        validateStatus: function (status) {
          return status < 500;
        }
      });
      // æ¶ˆæ¯å“åº”å·²è·å–
    } catch (e) {
      console.error('è·å–æ¶ˆæ¯åˆ—è¡¨å¤±è´¥:', e.message);
      // å¦‚æœè·å–æ¶ˆæ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯
      messagesResp = { status: 500, data: null };
    }

    // è§£æçœŸå®çš„AIå›å¤
    let response_text = '';
    let card_data = null;
    
    // å¤„ç†è¿”å›çš„æ¶ˆæ¯
    if (messagesResp.status === 200 && messagesResp.data?.data?.length > 0) {
      const messages = messagesResp.data.data;
      console.log(`æ‰¾åˆ° ${messages.length} æ¡æ¶ˆæ¯`);
      
      // æŸ¥æ‰¾åŠ©æ‰‹å›å¤
      let assistantMessages = [];
      for (let i = 0; i < messages.length; i++) {
        const msg = messages[i];
        if (msg.role === 'assistant' && (msg.type === 'answer' || msg.type === 'function_call' || msg.type === 'tool_response')) {
          assistantMessages.push(msg);
        }
      }
      
      // æ‹¼æ¥æ‰€æœ‰åŠ©æ‰‹æ¶ˆæ¯
      if (assistantMessages.length > 0) {
        // ä¼˜å…ˆä½¿ç”¨æœ€åä¸€æ¡answerç±»å‹çš„æ¶ˆæ¯
        const answerMsg = assistantMessages.reverse().find(msg => msg.type === 'answer' && msg.content);
        if (answerMsg) {
          response_text = answerMsg.content;
        } else {
          // å¦‚æœæ²¡æœ‰answerï¼Œä½¿ç”¨æ‰€æœ‰æœ‰å†…å®¹çš„æ¶ˆæ¯
          response_text = assistantMessages
            .filter(msg => msg.content)
            .map(msg => msg.content)
            .join('\n\n');
        }
        
        // åªæœ‰åœ¨æœ‰å®é™…å†…å®¹æ—¶æ‰è¿›è¡Œè§£æå’Œæ¸…ç†
        if (response_text && response_text.trim().length > 0) {
          // é¦–å…ˆæ£€æŸ¥æ˜¯å¦ä¸ºæ— å…³æé—®çš„å›ç­”
          if (isIrrelevantResponse(response_text)) {
            console.log('âœ… æ£€æµ‹åˆ°æ— å…³æé—®ï¼Œè¿”å›æ ‡å‡†å›å¤');
            response_text = 'æŠ±æ­‰ï¼Œæˆ‘ä»¬æ— æ³•ä¸ºæ‚¨æä¾›ç›¸å…³å†…å®¹çš„å›ç­”ï¼Œè¯·é—®æ‚¨æœ‰ä»€ä¹ˆç§‘ç ”åˆä½œéœ€æ±‚ï¼Ÿ';
            card_data = null; // ä¸ç”Ÿæˆæ•™æˆå¡ç‰‡
          } else {
            // æ··åˆé€»è¾‘ï¼šç»“åˆAIå›å¤å’Œæ•°æ®åº“ä¿¡æ¯
            card_data = await createHybridProfessorCards(input, response_text);
            
            if (card_data && card_data.professors && card_data.professors.length > 0) {
              // ç®€åŒ–å›ç­”æ–‡æœ¬ï¼Œè¯¦ç»†ä¿¡æ¯åœ¨å¡ç‰‡ä¸­æ˜¾ç¤º
              response_text = 'æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œä¸ºæ‚¨æ¨èä»¥ä¸‹æ•™æˆï¼š';
            } else {
              // å¤‡é€‰æ–¹æ¡ˆï¼šçº¯æ–‡æœ¬è§£æ
              card_data = parseProfesorInfoFromText(response_text);
              response_text = cleanResponseText(response_text, card_data, userInput);
            }
          }
        }
      }
    }
    
    // å¦‚æœæ²¡æ‰¾åˆ°æœ‰æ•ˆå›å¤ï¼Œç”Ÿæˆé»˜è®¤æ¶ˆæ¯
    if (!response_text || response_text.trim().length === 0) {
      if (chatStatus === 'in_progress') {
        response_text = 'æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨åé‡è¯•';
      } else if (chatStatus === 'failed') {
        response_text = 'å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ¢ä¸ªè¡¨è¾¾æ–¹å¼';  
      } else {
        response_text = 'æš‚æ—¶æ— æ³•å›å¤ï¼Œè¯·ç¨åé‡è¯•';
      }
    }
    
    // æ ¹æ®é—®é¢˜ç±»å‹å†³å®šè¿”å›ç­–ç•¥
    if (card_data && card_data.type === 'professor_list' && card_data.professors && card_data.professors.length > 0) {
      if (isIrrelevantResponse(response_text)) {
        card_data = null;
      } else if (!isSpecificProfessorInquiry(input)) {
        // å®½æ³›é—®é¢˜ï¼šåªè¿”å›å¡ç‰‡
        response_text = '';
      }
    }
    
    return { 
      code: 0, 
      data: { 
        response_text: response_text, 
        card_data: card_data, 
        conversation_id: conversation_id_new,
        raw: finalResult
      } 
    };
  } catch (e) {
    console.error('APIè°ƒç”¨å¤±è´¥:', e.message);
    
    return { 
      code: 500, 
      message: 'APIè°ƒç”¨å¤±è´¥: ' + e.message
    };
  }
};
